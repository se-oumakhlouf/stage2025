## ‚úÖ T√¢ches r√©alis√©es

- Cr√©ation d‚Äôun certificat dans l‚ÄôActive Directory **Samba** de test avec un **chemin explicite vers le container** `samba-ad` ‚Üí `CN=samba-ad`
    
- Changement de mot de passe : ‚úÖ **fonctionnel**
    
- Le **token** (lien) n‚Äôexpire pas ‚Üí seule la **dur√©e de validit√© du code de confirmation** est contr√¥l√©e
    
- Si un **code valide mais expir√©** est utilis√©, un **nouveau code** est automatiquement g√©n√©r√© et renvoy√© par e-mail √† l‚Äôutilisateur
    
- Mise en place de **nouveaux messages d‚Äôerreur** pour couvrir ces sc√©narios sp√©cifiques (code expir√©, erreur d‚Äôenvoi de mail, etc.)
    

---

## üìö Connaissances acquises

- Dans notre environnement local, le container backend √©choue au d√©marrage du **batch LDAP** si l‚ÄôAD Samba n‚Äôest pas encore pr√™t.
    
    - Ce probl√®me ne se produira **pas en production**, o√π l‚ÄôAD Samba est d√©j√† d√©marr√© et accessible.
        

---

## üêû Probl√®mes rencontr√©s

- 
    

---

## üîú √Ä faire demain

- Faire un point avec Pierre
	

---

## üß© Notes / Code

```java
public String modifyTokenCode (String tokenValue, String ldapId) {  
  Token token = getValidToken(tokenValue, ldapId);  
  if (token == null) {  
    return null;  
  }  
  token.setConfirmationCode(generateConfirmationCode());  
  token.setExpirationTime(LocalDateTime.now().plusMinutes(tokenExpirationMinutes));  
  tokenRepository.save(token);  
  return token.getConfirmationCode();  
}
```

```java
public ResponseEntity<?> handleExpiredConfirmationCode (String tokenValue, String ldapId) {  
  String confirmationCode = tokenService.modifyTokenCode(tokenValue, ldapId);  
  if (confirmationCode == null) {  
    logger.error("√âchec lors de la mise √† jour du code pour le token {}", tokenValue);  
    return buildUserErrorResponse();  
  }  
  
  String mail = openLdapService.getMail(ldapId).orElse(null);  
  if (mail == null) {  
    logger.error("Adresse mail introuvable pour l'utilisateur LDAP: {}", ldapId);  
    return buildUserErrorResponse();  
  }  
  
  boolean isEmailSent = emailService.sendResetPasswordEmail(  
      ldapId,  
      mail,  
      tokenValue,  
      confirmationCode  
  );  
  
  if (!isEmailSent) {  
    logger.error("√âchec de l'envoi de l'e-mail √† {}", mail);  
    return buildUserErrorResponse();  
  }  
  
  return ResponseEntity.status(HttpStatus.BAD_REQUEST)  
      .body(Collections.singletonMap("message", Messages.EXPIRED_CODE_SUCCESS));  
}  
  
private ResponseEntity<?> buildUserErrorResponse () {  
  return ResponseEntity.status(HttpStatus.BAD_REQUEST)  
      .body(Collections.singletonMap("message", Messages.EXPIRED_CODE_GENERIC));  
}
```

```java
public enum TokenValidationResult {  
  VALID,  
  TOKEN_INVALID,  
  TOKEN_EXPIRED,  
  CONFIRMATION_CODE_INVALID,  
  CONFIRMATION_CODE_EXPIRED  
}
```
## âœ… TÃ¢ches effectuÃ©es

- Adaptation du nom de domaine Ã  la configuration finale.
    
- VÃ©rification de la prÃ©sence de lâ€™utilisateur dans lâ€™Active Directory ainsi que la disponibilitÃ© du champ `mail`.
    
- Analyse et gestion des nouveaux messages dâ€™erreurs liÃ©s Ã  la recherche du champ `mail`.
    
- Tentatives dâ€™implÃ©mentation de la connexion sÃ©curisÃ©e LDAPS (port 636) pour les Ã©changes avec lâ€™AD.
    

---

## ğŸ“š Connaissances acquises

- Les erreurs sur le port 389 sont liÃ©es Ã  des problÃ¨mes dâ€™autorisation (droits dâ€™accÃ¨s Ã  lâ€™AD) plutÃ´t quâ€™Ã  une erreur de code.
    
- La configuration LDAPS est plus complexe Ã  mettre en place, nÃ©cessitant notamment :
    
    - Lâ€™activation et la configuration du service LDAPS sur Samba AD (certificats TLS, Ã©coute sur le port 636).
        
    - La vÃ©rification que le backend Docker peut rÃ©soudre le hostname `samba-ad` et joindre le port 636.
        
- Lâ€™erreur `Connection refused` sur LDAPS provient trÃ¨s probablement dâ€™un service Samba AD non joignable sur le port 636, soit parce que LDAPS nâ€™est pas activÃ©, soit Ã  cause dâ€™un problÃ¨me rÃ©seau (rÃ©solution DNS, rÃ©seau Docker, firewall).
    

---

## ğŸ ProblÃ¨mes rencontrÃ©s

- ComplexitÃ© de la configuration et activation correcte de LDAPS sur Samba AD, notamment :
    
    - Mise en place des certificats TLS nÃ©cessaires.
        
    - Assurance que le port 636 est bien exposÃ© et Ã©coutÃ© dans le container.
        
    
- ProblÃ¨mes de rÃ©solution DNS ou de rÃ©seau Docker empÃªchant le backend de joindre `samba-ad` sur le port LDAPS.
    
- Autorisations insuffisantes dans lâ€™AD lors des requÃªtes LDAP non sÃ©curisÃ©es.
    

---

## ğŸ”œ Ã€ faire demain

- Finaliser la configuration et lâ€™activation de LDAPS :
	
	- Contexte uniquement pour le changement de mot de passe pour Ã©viter de tous casser
	

---

## ğŸ§© Notes / Code

```java
# OpenLdapService

public LdapUserLookupResult checkUserAndMail(String openldapId) {  
  EqualsFilter filter = new EqualsFilter(uidAttribute, openldapId.trim());  
  try {  
    List<LdapUserLookupResult> results = ldapTemplate.search(  
        ldapBaseDn,  
        filter.encode(),  
        (AttributesMapper<LdapUserLookupResult>) attrs -> {  
          if (attrs.get(mailAttribute) != null) {  
            return LdapUserLookupResult.FOUND_WITH_MAIL;  
          } else {  
            return LdapUserLookupResult.FOUND_WITHOUT_MAIL;  
          }  
        }  
    );  
    return results.isEmpty() ? LdapUserLookupResult.NOT_FOUND : results.get(0);  
  } catch (Exception e) {  
    logger.error("Erreur lors de la recherche LDAP pour {}: {}", openldapId, e.getMessage());  
    return LdapUserLookupResult.NOT_FOUND;  
  }  
}  
  
public Optional<String> getMail (String openldapId) {  
  EqualsFilter filter = new EqualsFilter(uidAttribute, openldapId.trim());  
  try {  
    return ldapTemplate.search(ldapBaseDn, filter.encode(),  
        (AttributesMapper<String>) attrs -> {  
          Attribute mail = attrs.get(mailAttribute);  
          return mail != null ? mail.get().toString() : null;  
        }).stream().filter(Objects::nonNull).findFirst();  
  } catch (Exception e) {  
    return Optional.empty();  
  }  
}
```

```java
# Controller

  
@PostMapping("/generate")  
public ResponseEntity<?> generateToken(@RequestBody String openldapId) {  
  
  if (openldapId == null || !openldapId.matches("^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$")) {  
    return ResponseEntity.status(HttpStatus.BAD_REQUEST)  
        .body(Map.of("message", "Adresse e-mail invalide."));  
  }  
  
  LdapUserLookupResult result = openLdapService.checkUserAndMail(openldapId);  
  return switch (result) {  
    case NOT_FOUND -> {  
      logger.warn("Utilisateur {} introuvable dans Samba-AD.", openldapId);  
      yield ResponseEntity.status(HttpStatus.NOT_FOUND)  
          .body(Map.of("message", "Utilisateur introuvable dans Samba-AD."));  
    }  
    case FOUND_WITHOUT_MAIL -> {  
      logger.warn("Utilisateur {} trouvÃ© mais sans champ mail.", openldapId);  
      yield ResponseEntity.status(HttpStatus.NOT_FOUND)  
          .body(Map.of("message", "Utilisateur sans mail dans Samba-AD."));  
    }  
    case FOUND_WITH_MAIL -> {  
      String mail = openLdapService.getMail(openldapId).orElseThrow();  
      yield processPasswordReset(openldapId, mail, false);  
    }  
  };  
}
```
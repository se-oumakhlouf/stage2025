## ✅ Tâches effectuées

- Création d'index sur les `first|second_user_id` d'un `meeting` pour améliorer les performances de sélection de `user` sans `meeting`.
	
- Ajout du champ `User.meeting_id` (inclusions circulaire), augmente grandement les performances sans complexifié le maintien du code
	
- Exploration de keycloak
	

---

## 📚 Connaissances acquises

- Un index peut apporter un énorme gain de performance.
	

---

## 🐞 Problèmes rencontrés

- Tentative de suppressions plus rapides sans trigger, mais nécessite trop de maintenance / changement du code côté `backend`
	

---

## 🔜 À faire demain

- Continuer la tentative de mise ne place d'un keycloak de test
	

---

## 🧩 Notes / Code

```sql
analyze meetings;
ANALYZE
speed-dating-db=# EXPLAIN SELECT * FROM USERS u
WHERE NOT EXISTS (
  SELECT 1 FROM MEETINGS m
  WHERE m.first_user_id = u.id OR m.second_user_id = u.id
);
                                  QUERY PLAN
-------------------------------------------------------------------------------
 Nested Loop Anti Join  (cost=0.00..929113.13 rows=2794 width=65)
   Join Filter: ((m.first_user_id = u.id) OR (m.second_user_id = u.id))
   ->  Seq Scan on users u  (cost=0.00..246.48 rows=10948 width=65)
   ->  Materialize  (cost=0.00..133.25 rows=5417 width=16)
         ->  Seq Scan on meetings m  (cost=0.00..106.17 rows=5417 width=16)
 JIT:
   Functions: 7
   Options: Inlining true, Optimization true, Expressions true, Deforming true
(8 rows)



speed-dating-db=# CREATE INDEX idx_meetings_first_user_id ON meetings(first_user_id);
CREATE INDEX idx_meetings_second_user_id ON meetings(second_user_id);
CREATE INDEX
CREATE INDEX


speed-dating-db=# analyze meetings;
ANALYZE
speed-dating-db=# EXPLAIN SELECT * FROM USERS u
WHERE NOT EXISTS (
  SELECT 1 FROM MEETINGS m
  WHERE m.first_user_id = u.id OR m.second_user_id = u.id
);
                                              QUERY PLAN
------------------------------------------------------------------------------------------------------
 Nested Loop Anti Join  (cost=0.59..46421.79 rows=2794 width=65)
   ->  Seq Scan on users u  (cost=0.00..246.48 rows=10948 width=65)
   ->  Bitmap Heap Scan on meetings m  (cost=0.59..4.62 rows=2 width=16)
         Recheck Cond: ((first_user_id = u.id) OR (second_user_id = u.id))
         ->  BitmapOr  (cost=0.59..0.59 rows=2 width=0)
               ->  Bitmap Index Scan on idx_meetings_first_user_id  (cost=0.00..0.30 rows=1 width=0)
                     Index Cond: (first_user_id = u.id)
               ->  Bitmap Index Scan on idx_meetings_second_user_id  (cost=0.00..0.30 rows=1 width=0)
                     Index Cond: (second_user_id = u.id)
(9 rows)

speed-dating-db=#
```

```sql
speed-dating-db=# analyze users;
ANALYZE
speed-dating-db=# explain select * from users where meeting_id is not null;
                        QUERY PLAN
-----------------------------------------------------------
 Seq Scan on users  (cost=0.00..357.77 rows=9960 width=73)
   Filter: (meeting_id IS NOT NULL)
(2 rows)
```

```bash
docker run -p 127.0.0.1:8080:8080 -e KC_BOOTSTRAP_ADMIN_USERNAME=admin -e KC_BOOTSTRAP_ADMIN_PASSWORD=admin quay.io/keycloak/keycloak:26.3.1 start-dev
```